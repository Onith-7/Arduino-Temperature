<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Temperature Data from Arduino</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', Arial, sans-serif;
      background: linear-gradient(120deg, #e0e7ff 0%, #f4f4f4 100%);
      margin: 0;
      min-height: 100vh;
    }
    .container {
      max-width: 950px;
      margin: 40px auto;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.08);
      padding: 32px 28px 24px 28px;
    }
    h2 {
      text-align: center;
      font-weight: 600;
      color: #22223b;
      margin-bottom: 28px;
      letter-spacing: 1px;
    }
    .controls {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-bottom: 24px;
    }
    .controls input[type="file"] {
      padding: 8px 0;
    }
    .controls button {
      background: #0074D9;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 8px 18px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    .controls button:hover {
      background: #005fa3;
    }
    #graph {
      width: 100%;
      height: 80vh;
      min-height: 600px;
      margin: 0 auto 32px auto;
      background: #f8fafc;
      border-radius: 12px;
      box-shadow: 0 2px 8px #e0e7ff;
    }
    #data-table {
      width: 100%;
      margin: 0 auto;
      background: #f8fafc;
      border-radius: 10px;
      box-shadow: 0 2px 8px #e0e7ff;
      border-collapse: collapse;
      overflow: hidden;
    }
    #data-table th, #data-table td {
      border: 1px solid #e0e7ff;
      padding: 10px 14px;
      text-align: center;
      font-size: 1rem;
    }
    #data-table th {
      background: #0074D9;
      color: #fff;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    #data-table tr:nth-child(even) td {
      background: #f1f5fa;
    }
    #battery-status {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      margin-bottom: 10px;
    }
    #battery-icon {
      font-size: 1.5rem;
      margin-right: 8px;
    }
    #battery-level {
      font-size: 1.1rem;
      font-weight: 600;
    }
    #battery-warning {
      display: none;
      color: #fff;
      background: #FF4136;
      padding: 10px 18px;
      border-radius: 8px;
      font-weight: 600;
      text-align: center;
      margin-bottom: 16px;
    }
    @media (max-width: 700px) {
      .container { padding: 10px 2vw; }
      #graph { height: 40vh; }
      #data-table th, #data-table td { font-size: 0.9rem; padding: 6px 4px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="battery-status">
      <span id="battery-icon">ðŸ”‹</span>
      <span id="battery-level">Battery: 37%</span>
    </div>
    <div id="battery-warning"></div>
    <h2>Temperature Data from Arduino</h2>
    <div class="controls">
      <input type="file" id="csvFile" accept=".csv" />
      <button id="saveDataBtn">Save Data to Browser</button>
      <button id="loadDataBtn">Load Saved Data</button>
    </div>
    <div id="graph"></div>
    <div id="table-container"></div>
  </div>
  <script>
    // Embedded CSV data from your data.csv (comments and all)
    const defaultCSV = `Time,Temperature,Day\n0,22.1,Day 1\n1,22.3,Day 1\n2,22.5,Day 1\n3,22.7,Day 1\n4,22.8,Day 1\n5,23.0,Day 1\n6,23.2,Day 1\n7,23.3,Day 1\n8,23.5,Day 1\n9,23.7,Day 1\n10,23.9,Day 1\n11,24.1,Day 1\n12,24.3,Day 1\n13,24.5,Day 1\n14,24.7,Day 1\n15,24.9,Day 1\n16,25.1,Day 1\n17,25.3,Day 1\n18,25.5,Day 1\n19,25.7,Day 1\n20,25.9,Day 1\n21,26.1,Day 1\n22,26.3,Day 1\n23,26.5,Day 1\n0,22.0,Day 2\n1,22.2,Day 2\n2,22.4,Day 2\n3,22.6,Day 2\n4,22.8,Day 2\n5,23.0,Day 2\n6,23.2,Day 2\n7,23.4,Day 2\n8,23.6,Day 2\n9,23.8,Day 2\n10,24.0,Day 2\n11,24.2,Day 2\n12,24.4,Day 2\n13,24.6,Day 2\n14,24.8,Day 2\n15,25.0,Day 2\n16,25.2,Day 2\n17,25.4,Day 2\n18,25.6,Day 2\n19,25.8,Day 2\n20,26.0,Day 2\n21,26.2,Day 2\n22,26.4,Day 2\n23,26.6,Day 2\n0,22.2,Day 3\n1,22.4,Day 3\n2,22.6,Day 3\n3,22.8,Day 3\n4,23.0,Day 3\n5,23.2,Day 3\n6,23.4,Day 3\n7,23.6,Day 3\n8,23.8,Day 3\n9,24.0,Day 3\n10,24.2,Day 3\n11,24.4,Day 3\n12,24.6,Day 3\n13,24.8,Day 3\n14,25.0,Day 3\n15,25.2,Day 3\n16,25.4,Day 3\n17,25.6,Day 3\n18,25.8,Day 3\n19,26.0,Day 3\n20,26.2,Day 3\n21,26.4,Day 3\n22,26.6,Day 3\n23,26.8,Day 3\n0,22.3,Day 4\n1,22.5,Day 4\n2,22.7,Day 4\n3,22.9,Day 4\n4,23.1,Day 4\n5,23.3,Day 4\n6,23.5,Day 4\n7,23.7,Day 4\n8,23.9,Day 4\n9,24.1,Day 4\n10,24.3,Day 4\n11,24.5,Day 4\n12,24.7,Day 4\n13,24.9,Day 4\n14,25.1,Day 4\n15,25.3,Day 4\n16,25.5,Day 4\n17,25.7,Day 4\n18,25.9,Day 4\n19,26.1,Day 4\n20,26.3,Day 4\n21,26.5,Day 4\n22,26.7,Day 4\n23,26.9,Day 4\n0,22.4,Day 5\n1,22.6,Day 5\n2,22.8,Day 5\n3,23.0,Day 5\n4,23.2,Day 5\n5,23.4,Day 5\n6,23.6,Day 5\n7,23.8,Day 5\n8,24.0,Day 5\n9,24.2,Day 5\n10,24.4,Day 5\n11,24.6,Day 5\n12,24.8,Day 5\n13,25.0,Day 5\n14,25.2,Day 5\n15,25.4,Day 5\n16,25.6,Day 5\n17,25.8,Day 5\n18,26.0,Day 5\n19,26.2,Day 5\n20,26.4,Day 5\n21,26.6,Day 5\n22,26.8,Day 5\n23,27.0,Day 5\n0,22.5,Day 6\n1,22.7,Day 6\n2,22.9,Day 6\n3,23.1,Day 6\n4,23.3,Day 6\n5,23.5,Day 6\n6,23.7,Day 6\n7,23.9,Day 6\n8,24.1,Day 6\n9,24.3,Day 6\n10,24.5,Day 6\n11,24.7,Day 6\n12,24.9,Day 6\n13,25.1,Day 6\n14,25.3,Day 6\n15,25.5,Day 6\n16,25.7,Day 6\n17,25.9,Day 6\n18,26.1,Day 6\n19,26.3,Day 6\n20,26.5,Day 6\n21,26.7,Day 6\n22,26.9,Day 6\n23,27.1,Day 6\n0,22.6,Day 7\n1,22.8,Day 7\n2,23.0,Day 7\n3,23.2,Day 7\n4,23.4,Day 7\n5,23.6,Day 7\n6,23.8,Day 7\n7,24.0,Day 7\n8,24.2,Day 7\n9,24.4,Day 7\n10,24.6,Day 7\n11,24.8,Day 7\n12,25.0,Day 7\n13,25.2,Day 7\n14,25.4,Day 7\n15,25.6,Day 7\n16,25.8,Day 7\n17,26.0,Day 7\n18,26.2,Day 7\n19,26.4,Day 7\n20,26.6,Day 7\n21,26.8,Day 7\n22,27.0,Day 7\n23,27.2,Day 7\n0,22.7,Day 8\n1,22.9,Day 8\n2,23.1,Day 8\n3,23.3,Day 8\n4,23.5,Day 8\n5,23.7,Day 8\n6,23.9,Day 8\n7,24.1,Day 8\n8,24.3,Day 8\n9,24.5,Day 8\n10,24.7,Day 8\n11,24.9,Day 8\n12,25.1,Day 8\n13,25.3,Day 8\n14,25.5,Day 8\n15,25.7,Day 8\n16,25.9,Day 8\n17,26.1,Day 8\n18,26.3,Day 8\n19,26.5,Day 8\n20,26.7,Day 8\n21,26.9,Day 8\n22,27.1,Day 8\n23,27.3,Day 8\n0,22.8,Day 9\n1,23.0,Day 9\n2,23.2,Day 9\n3,23.4,Day 9\n4,23.6,Day 9\n5,23.8,Day 9\n6,24.0,Day 9\n7,24.2,Day 9\n8,24.4,Day 9\n9,24.6,Day 9\n10,24.8,Day 9\n11,25.0,Day 9\n12,25.2,Day 9\n13,25.4,Day 9\n14,25.6,Day 9\n15,25.8,Day 9\n16,26.0,Day 9\n17,26.2,Day 9\n18,26.4,Day 9\n19,26.6,Day 9\n20,26.8,Day 9\n21,27.0,Day 9\n22,27.2,Day 9\n23,27.4,Day 9\n0,22.9,Day 10\n1,23.1,Day 10\n2,23.3,Day 10\n3,23.5,Day 10\n4,23.7,Day 10\n5,23.9,Day 10\n6,24.1,Day 10\n7,24.3,Day 10\n8,24.5,Day 10\n9,24.7,Day 10\n10,24.9,Day 10\n11,25.1,Day 10\n12,25.3,Day 10\n13,25.5,Day 10\n14,25.7,Day 10\n15,25.9,Day 10\n16,26.1,Day 10\n17,26.3,Day 10\n18,26.5,Day 10\n19,26.7,Day 10\n20,26.9,Day 10\n21,27.1,Day 10\n22,27.3,Day 10\n23,27.5,Day 10`;

    function renderData(csvText) {
      // Remove comment lines (// Day X) and empty lines
      const lines = csvText.split('\n').filter(line => line.trim() && !line.startsWith('//'));
      const header = lines[0].split(',');
      // Detect columns
      let hourIdx = 0, tempIdx = 1, dayIdx = 2;
      for (let i = 0; i < header.length; i++) {
        const h = header[i].toLowerCase();
        if (h.includes('hour') || h === 'time') hourIdx = i;
        if (h.includes('temp')) tempIdx = i;
        if (h.includes('day')) dayIdx = i;
      }
      const time = [];
      const temp = [];
      const day = [];
      let tableHTML = '<table id="data-table"><thead><tr>';
      tableHTML += '<th>Day</th><th>Hour</th><th>Temperature (Â°C)</th>';
      tableHTML += '</tr></thead><tbody>';
      // Sort data by day and hour for a more logical table
      const tableRows = [];
      for (let i = 1; i < lines.length; i++) {
        const parts = lines[i].split(',');
        if (parts.length >= 3) {
          const hourVal = parts[hourIdx] || i-1;
          const tempVal = parts[tempIdx];
          const dayVal = parts[dayIdx] || 'Day 1';
          time.push(Number(hourVal));
          temp.push(Number(tempVal));
          day.push(dayVal);
          tableRows.push({ day: dayVal, hour: Number(hourVal), temp: tempVal });
        }
      }
      // Sort by day then hour
      tableRows.sort((a, b) => {
        if (a.day === b.day) return a.hour - b.hour;
        return a.day.localeCompare(b.day, undefined, { numeric: true });
      });
      tableRows.forEach(row => {
        tableHTML += `<tr><td>${row.day}</td><td>${row.hour}</td><td>${row.temp}</td></tr>`;
      });
      tableHTML += '</tbody></table>';
      document.getElementById('table-container').innerHTML = tableHTML;
      // Group by day for plotting
      const traces = [];
      const uniqueDays = [...new Set(day)];
      uniqueDays.forEach((d, idx) => {
        const x = [];
        const y = [];
        const text = [];
        // Use a color palette for better distinction
        const colors = [
          '#0074D9', '#FF4136', '#2ECC40', '#FF851B', '#B10DC9', '#FFDC00', '#39CCCC', '#01FF70', '#85144b', '#3D9970', '#111111', '#AAAAAA'
        ];
        const color = colors[idx % colors.length];
        for (let i = 0; i < day.length; i++) {
          if (day[i] === d) {
            x.push(time[i]);
            y.push(temp[i]);
            text.push(`<b>Day:</b> ${d}<br><b>Hour:</b> ${time[i]}<br><b>Temp:</b> ${temp[i]}Â°C`);
          }
        }
        traces.push({
          x: x,
          y: y,
          mode: 'markers',
          name: d,
          marker: { size: 10, color: color, line: { width: 2, color: '#fff' }, symbol: 'circle', opacity: 0.95 },
          text: text,
          hoverinfo: 'text',
          hovertemplate: '%{text}<extra></extra>'
        });
        traces.push({
          x: x,
          y: y,
          mode: 'lines',
          name: d,
          line: { width: 2, shape: 'spline', color: color },
          hoverinfo: 'skip',
          showlegend: false
        });
      });
      Plotly.newPlot('graph', traces, {
        xaxis: {
          title: header[hourIdx] || 'Hour',
          gridcolor: '#e0e7ff',
          zeroline: false,
          showline: true,
          linecolor: '#bfc9e0',
          tickfont: { color: '#22223b', size: 15 },
          titlefont: { size: 18, color: '#22223b' },
          dtick: 1,
        },
        yaxis: {
          title: header[tempIdx] || 'Temperature (Â°C)',
          gridcolor: '#e0e7ff',
          zeroline: false,
          showline: true,
          linecolor: '#bfc9e0',
          tickfont: { color: '#22223b', size: 15 },
          titlefont: { size: 18, color: '#22223b' },
          automargin: true,
          range: [Math.min(...temp) - 1, Math.max(...temp) + 1],
        },
        title: {
          text: 'Temperature Data from Arduino',
          font: { size: 28, color: '#22223b', family: 'Inter, Arial, sans-serif' }
        },
        margin: { t: 80, l: 80, r: 40, b: 80 },
        legend: {
          orientation: 'h',
          x: 0.5,
          xanchor: 'center',
          y: -0.25,
          font: { size: 16, color: '#22223b' },
          bgcolor: '#f8fafc',
          bordercolor: '#e0e7ff',
          borderwidth: 1
        },
        plot_bgcolor: '#f8fafc',
        paper_bgcolor: '#fff',
        hovermode: 'closest',
        modebar: { orientation: 'v' },
        transition: { duration: 500, easing: 'cubic-in-out' }
      }, {responsive: true});
    }

    document.getElementById('csvFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(event) {
        const csvText = event.target.result;
        localStorage.setItem('arduino_csv_data', csvText);
        renderData(csvText);
      };
      reader.readAsText(file);
    });

    document.getElementById('saveDataBtn').addEventListener('click', function() {
      const table = document.getElementById('data-table');
      if (!table) return;
      let csvText = '';
      const rows = table.querySelectorAll('tr');
      rows.forEach((row, i) => {
        const cells = row.querySelectorAll('th,td');
        let rowText = [];
        cells.forEach(cell => rowText.push(cell.textContent));
        csvText += rowText.join(',') + '\n';
      });
      localStorage.setItem('arduino_csv_data', csvText);
      alert('Data saved to browser!');
    });

    document.getElementById('loadDataBtn').addEventListener('click', function() {
      const csvText = localStorage.getItem('arduino_csv_data');
      if (csvText) {
        renderData(csvText);
      } else {
        alert('No saved data found.');
      }
    });

    // --- Battery Level Logic ---
    let batteryLevel = 100;
    let discharging = true;
    let batteryInterval = null;

    function updateBatteryLevel(level) {
      document.getElementById('battery-level').textContent = `Battery: ${level}%`;
      if (level < 20) {
        document.getElementById('battery-warning').style.display = 'block';
        document.getElementById('battery-warning').textContent = 'Warning: Arduino battery is low!';
        document.getElementById('battery-icon').textContent = 'ðŸª«';
      } else if (!discharging) {
        document.getElementById('battery-warning').style.display = 'block';
        document.getElementById('battery-warning').textContent = 'Recharging...';
        document.getElementById('battery-icon').textContent = 'ðŸ”Œ';
      } else {
        document.getElementById('battery-warning').style.display = 'none';
        document.getElementById('battery-icon').textContent = 'ðŸ”‹';
      }
    }

    function startBatteryCycle() {
      if (batteryInterval) clearInterval(batteryInterval);
      batteryInterval = setInterval(() => {
        if (discharging) {
          batteryLevel -= 5;
          if (batteryLevel <= 10) {
            batteryLevel = 10;
            discharging = false;
          }
        } else {
          batteryLevel += 5;
          if (batteryLevel >= 100) {
            batteryLevel = 100;
            discharging = true;
          }
        }
        updateBatteryLevel(batteryLevel);
      }, 60000); // 60000 ms = 1 minute
    }

    // On page load, set battery value and start cycle
    window.onload = function() {
      batteryLevel = 100;
      discharging = true;
      updateBatteryLevel(batteryLevel);
      startBatteryCycle();
      const csvText = localStorage.getItem('arduino_csv_data');
      if (csvText) {
        renderData(csvText);
      } else {
        renderData(defaultCSV);
      }
    };
  </script>
</body>
</html>
